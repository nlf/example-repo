name: nodejs nightly build

on:
  workflow_dispatch:

# used by setup-ccache-action's post hook to cleanup old caches
permissions:
  actions: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  # used for both the ccache key and artifact names
  key_prefix: nodejs-nightly 

jobs:
  build-nodejs:
    name: build nodejs
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.build-nodejs.outputs.version }}
    steps:
      - name: setup ccache
        uses: Chocobo1/setup-ccache-action@v1
        with:
          override_cache_key: ${{ env.key_prefix }}
      - name: checkout npm/cli
        uses: actions/checkout@v3
        with:
          repository: npm/cli
      - name: build nodejs
        id: build-nodejs
        run: |
          set -eo pipefail

          sourceDir="${RUNNER_TEMP}/src"
          targetDir="${RUNNER_TEMP}/build"
          sourceFile="${RUNNER_TEMP}/source.tgz"
          targetFile="${RUNNER_TEMP}/build.tgz"

          echo "::group::finding latest nightly version"
          version="$(curl -sSL https://nodejs.org/download/nightly/index.json | jq -r .[0].version)"
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "::endgroup::"

          echo "::group::extracting source"
          mkdir -p "$sourceDir"
          curl -sSL "https://nodejs.org/download/nightly/${version}/node-${version}.tar.gz" |\
            tar xz -C "$sourceDir" --strip=1
          echo "::endgroup::"

          echo "::group::packing npm release"
          node . run resetdeps
          npmtarball="$(node . pack --loglevel=silent --json | jq -r .[0].filename)"
          rm -rf "${sourceDir}/deps/npm"
          mkdir -p "${sourceDir}/deps/npm"
          tar xfz "$npmtarball" -C "${sourceDir}/deps/npm" --strip=1
          echo "::endgroup::"

          echo "::group::packing nodejs source"
          tar cfz "$sourceFile" -C "$sourceDir" .
          echo "source=$sourceFile" >> $GITHUB_OUTPUT
          echo "::endgroup::"

          echo "::group::building nodejs"
          mkdir -p "$targetDir"
          pushd "$sourceDir" >/dev/null
          ./configure --prefix="$targetDir"
          make -j4 install
          popd >/dev/null
          echo "::endgroup::"

          echo "::group::packing nodejs build"
          tar cfz "$targetFile" -C "$targetDir" .
          echo "build=$targetFile" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.key_prefix }}-${{ steps.build-nodejs.outputs.version }}
          path: |
            ${{ steps.build-nodejs.outputs.source }}
            ${{ steps.build-nodejs.outputs.build }}

  test-nodejs:
    name: test nodejs
    runs-on: ubuntu-latest
    needs:
      - build-nodejs
    outputs:
      version: ${{ needs.build-nodejs.outputs.version }}
    steps:
      - name: setup ccache
        uses: Chocobo1/setup-ccache-action@v1
        with:
          override_cache_key: ${{ env.key_prefix }}
      - name: download artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.key_prefix }}-${{ needs.build-nodejs.outputs.version }}
      - name: test nodejs
        run: |
          tar xf source.tgz
          ./configure
          make -j4 test-only

  test-npm:
    name: test npm
    runs-on: ubuntu-latest
    needs:
      - build-nodejs
    steps:
      - name: checkout npm/cli
        uses: actions/checkout@v3
        with:
          repository: npm/cli
      - name: download artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.key_prefix }}-${{ needs.build-nodejs.outputs.version }}
          path: ${{ runner.temp }}
      - name: install nodejs ${{ needs.build-nodejs.outputs.version }}
        id: install
        run: |
          mkdir -p "${RUNNER_TEMP}/node"
          tar xf "${RUNNER_TEMP}/build.tgz" -C "${RUNNER_TEMP}/node"

          echo "${RUNNER_TEMP}/node/bin" >> $GITHUB_PATH
          echo "cache=$(npm config get cache)" >> $GITHUB_OUTPUT
      - name: setup npm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.install.outputs.cache }}
          key: npm-tests
      - run: node --version
      - run: npm --version
      - name: test npm
        run: |
          node . run resetdeps
          node . link
          node . run test -ws -iwr --if-present --ignore-scripts

  build-matrix:
    name: build matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    steps:
      - name: build matrix
        id: build-matrix
        uses: actions/github-script@v6
        with:
          script: |
            const matchesKeyword = (value) => {
              const keywords = ['ubuntu', 'debian', 'linux', 'x86', '>=11', '>=12', '>=16', '>=17']
              if (value === true ||
                  (typeof value === 'string' && keywords.includes(value)) ||
                  (Array.isArray(value) && keywords.some((keyword) => value.includes(keyword) || value.includes(true)))) {
                return true
              }

              return false
            }

            // this is a manually updated list of packages that we know currently fail
            const knownFailures = [
              'body-parser', // json parsing error difference
              'clinic', // unknown, lots of failures
              'ember-cli', // timeout in nodejs ci, one failing test for us that timed out
              'express', // body-parser is what actually fails, it's used in a test
              'https-proxy-agent', // looks ssl related
              'node-gyp', // one test consistently times out
              'resolve', // compares results to require.resolve and fails, also missing inspector/promises
              'serialport', // esbuild barfs on node 20.0.0-pre
              'uuid', // tests that crypto.getRandomValues throws but it doesn't
            ]


            await exec.exec('npm', ['install', 'citgm'])
            const lookup = require('./node_modules/citgm/lib/lookup.json')
            const matrix = []
            for (const key in lookup) {
              const item = lookup[key]
              if (matchesKeyword(item.skip) || item.yarn === true) {
                continue
              }

              matrix.push({ package: key, flaky: matchesKeyword(item.flaky), knownFailure: knownFailures.includes(key) })
            }
            core.setOutput('matrix', matrix)

  npm-ls:
    name: npm ls ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs:
      - build-nodejs
      - build-matrix
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
    steps:
      - name: download artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.key_prefix }}-${{ needs.build-nodejs.outputs.version }}
      - name: install nodejs ${{ needs.build-nodejs.outputs.version }}
        id: install
        run: |
          mkdir -p ./node
          tar xf build.tgz -C ./node
          mkdir -p ./node-src
          tar xf source.tgz -C ./node-src

          echo "$(pwd)/node/bin" >> $GITHUB_PATH
          echo "cache=$(npm config get cache)" >> $GITHUB_OUTPUT
      - name: setup npm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.install.outputs.cache }}
          key: npm-${{ matrix.package }}
      - run: node --version
      - run: npm --version
      - name: npm ls
        run: |
          npm i -g citgm
          echo "require('child_process').execSync('npm ls')" > "${RUNNER_TEMP}/citgm-npm-ls.js"
          citgm --tap --nodedir=./node-src --customTest="${RUNNER_TEMP}/citgm-npm-ls.js" ${{ matrix.package }}

  citgm:
    name: citgm ${{ matrix.package }} ${{ matrix.flaky && '(flaky)' || '' }} ${{ matrix.knownFailure && '(known failure)' || '' }}
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.flaky || matrix.knownFailure }}
    needs:
      - build-nodejs
      - build-matrix
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
    steps:
      - name: download artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.key_prefix }}-${{ needs.build-nodejs.outputs.version }}
      - name: install nodejs ${{ needs.build-nodejs.outputs.version }}
        id: install
        run: |
          mkdir -p ./node
          tar xf build.tgz -C ./node
          mkdir -p ./node-src
          tar xf source.tgz -C ./node-src

          echo "$(pwd)/node/bin" >> $GITHUB_PATH
          echo "cache=$(npm config get cache)" >> $GITHUB_OUTPUT
      - name: setup npm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.install.outputs.cache }}
          key: npm-${{ matrix.package }}
      - run: node --version
      - run: npm --version
      - name: citgm
        run: |
          npm i -g citgm@latest
          citgm --tap --nodedir=./node-src ${{ matrix.package }}
