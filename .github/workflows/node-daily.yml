name: nightly nodejs ci
on:
  workflow_dispatch:

jobs:
  build-nightly:
    runs-on: ubuntu-latest
    outputs:
      artifact: ${{ steps.build-nightly.outputs.artifact }}
      version: ${{ steps.build-nightly.outputs.version }}
    steps:
      - name: Checkout npm/cli
        uses: actions/checkout@v3
        with:
          repository: 'npm/cli'
      - name: Install ccache
        uses: hendrikmuhs/ccache-action@v1.2
      - name: Build nodejs nightly
        uses: actions/github-script@v6
        id: build-nightly
        with:
          script: |
            // add ccache to the path
            core.addPath('/usr/local/opt/ccache/libexec')
            core.addPath('/usr/lib/ccache')

            // setup some common vars
            const tmpDir = process.env.RUNNER_TEMP
            const sourceDir = `${tmpDir}/src`
            const targetDir = `${tmpDir}/build`
            const targetFile = `${targetDir}.tgz`

            // find the version of the latest nightly
            core.startGroup('finding version of latest nightly nodejs')
            await exec.exec('curl', ['-o', `${tmpDir}/nightlies.json`, 'https://nodejs.org/download/nightly/index.json'])
            const availableNightlies = require(`${tmpDir}/nightlies.json`)
            const { version } = availableNightlies[0]
            core.setOutput('version', version)
            core.endGroup()

            // download the source tarball
            core.startGroup(`retrieving nodejs nightly ${version}`)
            await exec.exec('curl', ['-o', `${tmpDir}/node-${version}.tar.xz`, `https://nodejs.org/download/nightly/${version}/node-${version}.tar.xz`])

            // extract the source
            await io.mkdirP(sourceDir)
            await exec.exec('tar', ['xf', `${tmpDir}/node-${version}.tar.xz`, '--strip=1', '-C', sourceDir])
            core.endGroup()

            // update the bundled npm
            core.startGroup('updating bundled npm')
            await exec.exec('node', ['.', 'run', 'resetdeps'])

            let npmTarball = ''
            await exec.exec('node', ['.', 'pack', '--loglevel=silent'], {
              listeners: {
                stdout: (data) => {
                  npmTarball += data
                },
              },
            })
            npmTarball = npmTarball
              .trim()
              .split(/\n/g)
              .find((item) => {
                return item.startsWith('npm-') && item.endsWith('.tgz')
              })

            await io.rmRF(`${sourceDir}/deps/npm`)
            await io.mkdirP(`${sourceDir}/deps/npm`)

            await exec.exec('tar', ['xf', npmTarball, '-C', `${sourceDir}/deps/npm/`, '--strip=1'])
            core.endGroup()

            // configure the source directory
            core.startGroup('configuring nodejs build')
            await exec.exec('./configure', ['--prefix', targetDir], { cwd: sourceDir })
            core.endGroup()

            // run tests
            core.startGroup('running nodejs tests')
            await exec.exec('make', ['-j4', 'test-only'], { cwd: sourceDir })
            core.endGroup()

            // generate build artifact
            core.startGroup('generating nightly nodejs build')
            await exec.exec('make', ['install'], { cwd: sourceDir })
            await exec.exec('tar', ['cfz', targetFile, '.'], { cwd: targetDir })
            core.setOutput('artifact', targetFile)
            core.endGroup()
      - name: Upload nodejs artifact
        uses: actions/upload-artifact@v3
        with:
          name: nodejs-nightly-${{ steps.build-nightly.outputs.version }}
          path: ${{ steps.build-nightly.outputs.artifact }}
      # - name: Add nightly nodejs to path
      #   uses: actions/github-script@v6
      #   with:
      #     script: |
      #       core.addPath(`${process.env.RUNNER_TEMP}/node/bin`)
      # - name: Node version
      #   run: |
      #     node --version
      # - name: npm version
      #   run: |
      #     npm --version
      # - name: Find npm cache directory
      #   id: npm-cache
      #   run: |
      #     echo "::set-output name=dir::$(npm config get cache)"
      # - name: Setup npm cache
      #   uses: actions/cache@v3
      #   with:
      #     path: ${{ steps.npm-cache.outputs.dir }}
      #     key: "npm-cache"
      # - name: Install citgm
      #   run: |
      #     npm i -g citgm
      # - name: Run citgm
      #   run: |
      #     echo 'require("child_process").execSync("npm ls")' > "${RUNNER_TEMP}/npm-ls.js"
      #     citgm-all --markdown --nodedir "${RUNNER_TEMP}/nodejs" --excludeTags yarn --customTest "${RUNNER_TEMP}/npm-ls.js"
